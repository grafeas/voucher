package containeranalysis

import (
	"strings"

	grafeas "google.golang.org/genproto/googleapis/grafeas/v1"

	"github.com/Shopify/voucher"
)

// vulProject is the project that Google's Container Analysis writes vulnerability
// occurrences to.
const vulProject = "projects/goog-vulnz/notes/"

// getSeverity translates the Google Container Analysis Severity to a Voucher Severity.
func getSeverity(severity string) voucher.Severity {
	switch severity {
	case "MINIMAL":
		return voucher.NegligibleSeverity
	case "LOW":
		return voucher.LowSeverity
	case "MEDIUM":
		return voucher.MediumSeverity
	case "HIGH":
		return voucher.HighSeverity
	case "CRITICAL":
		return voucher.CriticalSeverity
	}

	return voucher.UnknownSeverity
}

// OccurrenceToVulnerability converts an Occurrence to a Vulnerability.
func OccurrenceToVulnerability(occ *grafeas.Occurrence) voucher.Vulnerability {
	vulnDetails := occ.GetDetails().(*grafeas.Occurrence_Vulnerability).Vulnerability

	return voucher.Vulnerability{
		Name:     strings.Replace(occ.GetNoteName(), vulProject, "", 1),
		Severity: getSeverity(grafeas.Severity_name[int32(vulnDetails.Severity)]),
	}
}
